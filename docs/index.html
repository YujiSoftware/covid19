<!DOCTYPE html>
<html>
    <head>
        <title>新型コロナウィルス都道府県別感染者数の傾向</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="新型コロナウィルス都道府県別感染者数の傾向"/>
        <meta property="og:description" content="4/18 新型コロナウィルスの都道府県別感染者数グラフ一覧"/>
        <meta property="og:image" content="https://kishida.github.io/covid19/map.png"/>
        <meta property="og:url" content="https://kishida.github.io/covid19/"/>
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:site" content="@kis"/>
        <style type="text/css">
            .tableRow {
                display: table-row;
            }
            .chartCell {
                max-width: 200px;
                max-height: 200px;
                min-width: 200px;
                min-height: 200px;
                display: table-cell;
            }
        </style>
    </head>
    <body>
        <h1>新型コロナウィルス都道府県別感染者数の傾向</h1>
        <div>
            Naoki Kishida(<a href="https://twitter.com/kis">@kis</a>) Last Update: <span id="update"></span><br/>
        </div>
        <div style="display: inline-block">
        <div id="map"></div>
        (赤: 感染拡大中, 緑: 感染収れん)
        </div>
        <div style="display: inline-block; max-width: 550px; max-height: 300px; min-width: 550px; min-height: 300px;">
            <canvas id="bar"></canvas>
        </div>
        <div style="display:block"></div>
        <div>
            <input type="radio" id="type1" name="type" value="1" checked><label for="type1">感染者+死亡者</label>
            <input type="radio" id="type2" name="type" value="2"><label for="type2">感染者</label>
            <input type="radio" id="type3" name="type" value="3"><label for="type3">死亡者</label>
        </div>
        <div>
            <input type="radio" id="calc1" name="calc" value="1" checked><label for="calc1">発生</label>
            <input type="radio" id="calc2" name="calc" value="2"><label for="calc2">累積</label>
        </div>
        <div>
            <input type="radio" id="axis1" name="axis" value="1" checked><label for="axis1">線形軸</label>
            <input type="radio" id="axis2" name="axis" value="2"><label for="axis2">対数軸</label>
        </div>
        <div id="data" style="display: table;">
            
        </div>
        <div>
            データは <a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000121431_00086.html">厚生労働省のサイト</a>の3/8発表分以降。死者は3/20から<br/>
            日時は発表日時。3/29より前は患者数であったのが感染者数に変わったためギャップがある。<br/>
            福岡県は4/1以降は厚生労働省の集計値ではなく県の発表値を使っている。
        </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="jquery.japan-map.min.js"></script>
    <script src="prefs.js"></script>
    <script>
        $("#update").text(data.lastUpdate);
        var c = $("#data");
        var row = $('<div class="tableRow"></div>');
        var firstrow = row;
        var x = 1;
        var areas = [];
        var charts = [];
        var total = Array(data.prefs[0].patients.length);
        total.fill(0);
        var motarity = Array(data.prefs[0].motarity.length);
        motarity.fill(0);
        data.prefs.forEach(pref => {
            var slice = pref.patients.slice(-3);
            
            for (var i = 0; i < pref.patients.length; ++i) {
                total[i] += pref.patients[i];
                motarity[i] += pref.motarity[i];
            }
            
            // map data
            var pre = slice[0];
            var post = slice[2];
            var rate;
            const thresould = 1.5;
            if (pre === 0) {
                if (post > 0) {
                    rate = thresould;
                } else {
                    rate = 1;
                }
            } else {
                rate = post / pre;
            }

            if (rate > thresould) {
                rate = 1;
            } else {
                rate = (Math.sqrt(rate) - 1) / (Math.sqrt(thresould) - 1);
            }
            if (rate < 0) {
                rate = 0;
            }
            areas.push({
                code: pref.code,
                jp: pref.pref,
                color: "rgba(" + Math.floor(255 * rate) + "," + Math.floor(255 * (1-rate)) + ",0,.7)",
                prefectures: [pref.code]
            });
            
            var motal = pref.motarity.slice(-1)[0];
            [div, chart] = createChart(pref.pref, pref.dates, post, motal, pref.patients, pref.motarity, true);
            row.append(div);
            charts.push(chart);
            ++x;
            if (x === 5) {
                x = 0;
                c.append(row);
                row = $('<div class="tableRow"></div>');
            }
        });
        if (x > 0) {
            c.append(row);
        }

        var post = total.slice(-1)[0];
        var mot = motarity.slice(-1)[0];
        [div, chart] = createChart("全国", data.prefs[0].dates, post, mot, total, motarity, false);
        charts.push(chart);
        firstrow.prepend(div);
        
        $("#map").japanMap({
            areas: areas,
            movesIslands: true,
            height: 300
        });
        var prefsChart = new Chart(document.getElementById("bar").getContext("2d"), {
            type: 'bar',
            data: {
                labels: latest.prefs,
                datasets: [{
                        label: "感染者数",
                        data: latest.patients,
                        backgroundColor: "rgba(0, 255, 0, 0.5)"
                }]
            },
            options: {
                legend: {
                   display: false
               },
               scales: {
                   xAxes: [{
                           ticks: {
                               maxRotation: 90
                           }
                   }]
               }
            }
        });
        
        function typeChanged(){
            if ($('input[name="calc"]:checked').val() === '2') {
                offset = 0;
                labelOffset = 0;
            } else {
                offset = 2;
                labelOffset = 1;
            }
            var sel = $('input[name="type"]:checked').val();
            charts.forEach(ch => {
                switch (sel) {
                    case '1':
                        ch.data.datasets = [ch.data.datapool[0 + offset], ch.data.datapool[1 + offset]];
                        break;
                    case '2':
                        ch.data.datasets = [ch.data.datapool[0 + offset]];
                        break;
                    case '3':
                        ch.data.datasets = [ch.data.datapool[1 + offset]];
                        break;
                }
                ch.data.labels = ch.data.dateLabels.slice(labelOffset);
                ch.update();
            });
        }
        
        $('input[name="type"]:radio').change(typeChanged);
        $('input[name="calc"]:radio').change(typeChanged);
        
        $('input[name="axis"]:radio').change(function() {
            var type = 'linear';
            if ($(this).val() === '2') {
                type = 'logarithmic';
            }
            charts.forEach(ch => {
                ch.options.scales.yAxes[0].type = type;
                if (ch.options.pref) {
                    if ($(this).val() === '2') {
                        if ($('input[name="calc"]:checked').val() === '2') {
                            m = 3000;
                        } else {
                            m = 300;
                        }
                        ch.options.scales.yAxes[0].ticks.max = m;
                    } else {
                        delete ch.options.scales.yAxes[0].ticks.max;
                    }
                }
                ch.update();
            });
            prefsChart.options.scales.yAxes[0].type = type;
            prefsChart.update();
        });
        
        function createChart(name, dates, infect, motal, patients, motarity, pref) {
            var weekData = patients.slice(-8);
            var weekAgo = weekData[0];
            var rateText;
            if (weekAgo === 0) {
                rateText = "-倍/週";
            } else {
                rateText = (Math.round(infect / weekAgo * 100) / 100) + "倍/週";
            }
            
            var div = $('<div class="chartCell"></div>');
            var prefName = $('<div></div>');
            prefName.text(name + "(感染:" + infect + " 死者:" + motal + ")");
            div.append(prefName);
            var rateDiv = $('<div></div>');
            var rateSpan = $('<span></span>');
            rateSpan.text(rateText);
            rateDiv.append(rateSpan);
            var compare = $('<span></span>');
            compare.text(" 前日比 " + (weekData[7] - weekData[6]));
            rateDiv.append(compare);
            div.append(rateDiv);
            var canv =  $('<canvas></canvas');
            div.append(canv);
            row.append(div);
        
            var ctx = canv.get(0).getContext("2d");
            var patdif = new Array();
            var deathdif = new Array();
            for (var i = 1; i < patients.length; ++i) {
                patdif.push(Math.max(patients[i] - patients[i - 1], 0));
                if (i <= 12) {
                    deathdif.push(0); // until 3/20
                } else {
                    deathdif.push(Math.max(motarity[i] - motarity[i - 1], 0));
                }
            }
            var chart = new Chart(ctx, {
               type: 'bar',
               data: {
                   dateLabels : dates,
                   datapool: [{
                           type: 'line',
                           label: "感染者",
                           data: patients,
                           backgroundColor: "rgba(153,255,51,0.4)",
                           pointRadius: 0,
                           pointHitRadius: 3
                        },
                        {
                           type: 'line',
                           label: "死者",
                           data: motarity,
                           backgroundColor: "rgba(255,53,51,1)",
                           pointRadius: 0,
                           pointHitRadius: 3
                            
                        },
                        {
                           type: 'bar',
                           label: "感染者",
                           data: patdif,
                           backgroundColor: "rgba(0,155, 0,1)",
                        },
                        {
                           type: 'bar',
                           label: "死者",
                           data: deathdif,
                           backgroundColor: "rgba(255,53,51,1)",
                        }                        
                   ]
               },
               options: {
                   pref: pref,
                   legend: {
                       display: false
                   },
                   scales: {
                       yAxes: [{
                               ticks: {
                                   beginAtZero: true
                               },
                               type: 'linear'
                       }],
                       xAxes: [{
                           display: false
                       }]

                   }
               }
            });
            chart.data.datasets = [chart.data.datapool[2], chart.data.datapool[3]];
            chart.data.labels = chart.data.dateLabels.slice(1);
            chart.update();
            return [div, chart];
        }
        
    </script>
    </body>
</html>
