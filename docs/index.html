<!DOCTYPE html>
<html>
    <head>
        <title>都道府県別感染者数の傾向</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <h1>都道府県別感染者数の傾向</h1>
        <div>
            Naoki Kishida(<a href="https://twitter.com/kis">@kis</a>) Last Update: <span id="update"></span>
        </div>
        <div id="map"></div>
        (赤: 感染拡大中, 緑: 感染収れん)
        <div id="data" style="display: table;">
            
        </div>
        
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="jquery.japan-map.min.js"></script>
    <script src="prefs.js"></script>
    <script>
        $("#update").text(data.lastUpdate);
        var c = $("#data");
        var row = $('<div style="display: table-row"></div>');
        var firstrow = row;
        var x = 1;
        var areas = [];
        var total = Array(data.prefs[0].patients.length);
        total.fill(0);
        data.prefs.forEach(pref => {
            var slice = pref.patients.slice(-3);
            
            for (var i = 0; i < pref.patients.length; ++i) {
                total[i] += pref.patients[i];
            }
            
            // map data
            var pre = slice[0];
            var post = slice[2];
            var rate;
            if (pre === 0) {
                if (post > 0) {
                    rate = 1.5;
                } else {
                    rate = 1;
                }
            } else {
                rate = post / pre;
            }
            if (rate > 1.5) {
                rate = 1;
            } else {
                rate = (rate - 1) / 0.5;
            }
            areas.push({
                code: pref.code,
                jp: pref.pref,
                color: "rgba(" + Math.floor(255 * rate) + "," + Math.floor(255 * (1-rate)) + ",0,.7)",
                prefectures: [pref.code]
            });
            
            var div = $('<div style="max-width: 200px; max-height: 200px; min-width: 200px; min-height: 200px; display: table-cell"></div>');
            var prefName = $('<div></div>');
            prefName.text(pref.pref + "(" + post + ")");
            div.append(prefName);
            var canv =  $('<canvas></canvas');
            div.append(canv);
            row.append(div);
        
            //var canv = document.getElementById(pref.pref);
            var ctx = canv.get(0).getContext("2d");
            new Chart(ctx, {
               type: 'line',
               data: {
                   labels: pref.dates,
                   datasets: [{
                           label: pref.pref,
                           data: pref.patients,
                           backgroundColor: "rgba(153,255,51,0.4)"
                   }]
               },
               options: {
                   legend: {
                       display: false
                   },
                   scales: {
                       yAxes: [{
                               ticks: {
                                   beginAtZero: true
                               }
                       }],
                       xAxes: [{
                           display: false
                       }]

                   }
               }
            });
            ++x;
            if (x == 5) {
                x = 0;
                c.append(row);
                row = $('<div style="display: table-row"></div>');
            }
        });
        if (x > 0) {
            c.append(row);
        }
        
        var div = $('<div style="max-width: 200px; max-height: 200px; min-width: 200px; min-height: 200px; display: table-cell"></div>');
        var prefName = $('<div></div>');
        var post = total.slice(-1)[0];
        prefName.text("全国(" + post + ")");
        div.append(prefName);
        var canv =  $('<canvas></canvas');
        div.append(canv);
        row.append(div);

        //var canv = document.getElementById(pref.pref);
        var ctx = canv.get(0).getContext("2d");
        new Chart(ctx, {
           type: 'line',
           data: {
               labels: data.prefs[0].dates,
               datasets: [{
                       label: "全国",
                       data: total,
                       backgroundColor: "rgba(153,255,51,0.4)"
               }]
           },
           options: {
               legend: {
                   display: false
               },
               scales: {
                   yAxes: [{
                           ticks: {
                               beginAtZero: true
                           }
                   }],
                   xAxes: [{
                       display: false
                   }]

               }
           }
        });
        firstrow.prepend(div);
        
        $("#map").japanMap({
            areas: areas,
            movesIslands: true,
            height: 300
        });
        
    </script>
    </body>
</html>
